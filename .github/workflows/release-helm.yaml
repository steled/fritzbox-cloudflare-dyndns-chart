name: âŽˆ Release Helm Chart

on:
  workflow_run:
    workflows: ["ðŸ¦¾ Auto Tag Version"]
    types:
      - completed

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  release-chart:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Extract version from latest tag
        id: vars
        run: |
          echo "VERSION=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV
          echo "Detected VERSION=$VERSION"

      - name: Helm Lint
        run: |
          helm lint charts/fritzbox-cloudflare-dyndns-chart

      - name: Update Helm Chart version
        run: |
          yq eval ".version = \"${VERSION#v}\"" -i charts/fritzbox-cloudflare-dyndns-chart/Chart.yaml
          yq eval ".appVersion = \"${VERSION#v}\"" -i charts/fritzbox-cloudflare-dyndns-chart/Chart.yaml

      - name: Commit updated Chart.yaml
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add charts/fritzbox-cloudflare-dyndns-chart/Chart.yaml
          git commit -m "Update chart version to ${VERSION#v}" || echo "No changes to commit"
          git push origin HEAD:main

      - name: Helm install test (dry-run)
        run: |
          helm install test charts/fritzbox-cloudflare-dyndns-chart --dry-run --debug

      - name: Package Helm Chart
        run: |
          mkdir -p packaged
          helm package charts/fritzbox-cloudflare-dyndns-chart \
            --version ${VERSION#v} \
            --destination packaged

      - name: Checkout gh-pages branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: gh-pages
          path: ghpages

      - name: Merge packaged artifacts into gh-pages
        run: |
          mkdir -p ghpages
          cp packaged/*.tgz ghpages/

          cd ghpages

          if [ -f index.yaml ]; then
            echo "Merging into existing index.yaml"
            helm repo index . \
              --url https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/} \
              --merge index.yaml
          else
            echo "Creating new index.yaml"
            helm repo index . \
              --url https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}
          fi

      - name: Commit and push GH-PAGES changes
        run: |
          cd ghpages
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add .
          git commit -m "Update helm repo for ${VERSION#v}" || echo "Nothing to commit"
          git push origin gh-pages

      - name: Publish Helm chart to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: dist
          keep_files: true
